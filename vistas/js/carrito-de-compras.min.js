if(null!=localStorage.getItem("cantidadCesta")?($(".cantidadCesta").html(localStorage.getItem("cantidadCesta")),$(".sumaCesta").html(localStorage.getItem("sumaCesta"))):($(".cantidadCesta").html("0"),$(".sumaCesta").html("0")),null!=localStorage.getItem("listaProductos")){var listaCarrito=JSON.parse(localStorage.getItem("listaProductos"));function functionForEach(item,index){var datosProducto=new FormData,precio=0;datosProducto.append("id",item.idProducto),$.ajax({url:rutaOculta+"ajax/producto.ajax.php",method:"POST",data:datosProducto,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(respuesta){precio=0==respuesta.precioOferta?respuesta.precio:respuesta.precioOferta,$(".cuerpoCarrito").append('<div clas="row itemCarrito"><div class="col-sm-1 col-xs-12"><br><button class="btn btn-default backColor quitarItemCarrito" idProducto="'+item.idProducto+'"  peso="'+item.peso+'" ><i class="fa fa-times"></i></button></div><div class="col-sm-1 col-xs-12"><figure><img src="'+item.imagen+'" class="img-thumbnail"></figure></div><div class="col-sm-4 col-xs-12"><br><p class="tituloCarritoCompra text-left">'+item.titulo+'</p></div><div class="col-md-2 col-sm-1 col-xs-12"><br><p class="precioCarritoCompra text-center">PEN S/.<span>'+precio+'</span></p></div><div class="col-md-2 col-sm-3 col-xs-8"><br><div class="col-xs-8" style="top:-20px"><p class="cantidadStock text-left"  style="margin-top:-10px;margin-bottom:-10px;display:none;" stock="'+item.stock+'" >'+item.stock+'</p><br><input type="number" class="form-control cantidadItem" min="1"  value="'+item.cantidad+'" tipo="'+item.tipo+'"   precio="'+item.precio+'"  idProducto="'+item.idProducto+'" ></div></div><div class="col-md-2 col-sm-1 col-xs-4 text-center"><br><p class="subTotal'+item.idProducto+' subtotales"><strong>PEN S/.<span>'+item.precio+'</span></strong></p></div></div><div class="clearfix"></div><br>'),$(".cantidadItem[tipo='virtual']").attr("readonly","true");for(var precioCarritoCompra=$(".cuerpoCarrito .precioCarritoCompra span"),cantidadItem=$(".cuerpoCarrito .cantidadItem"),i=0;i<precioCarritoCompra.length;i++){var precioCarritoCompraArray=$(precioCarritoCompra[i]).html(),cantidadItemArray=$(cantidadItem[i]).val(),idProductoArray=$(cantidadItem[i]).attr("idProducto");$(".subTotal"+idProductoArray).html("<strong>PEN S/.<span>"+(precioCarritoCompraArray*cantidadItemArray).toFixed(2)+"</span></strong>"),sumaSubtotales(),cestaCarrito(precioCarritoCompra.length)}}})}listaCarrito.forEach(functionForEach)}else $(".cuerpoCarrito").html('<div class="well"style="background-color: #0d1117;">Aún no hay productos en el carrito de compras.</div>'),$(".sumaCarrito").hide(),$(".cabeceraCheckout").hide();function sumaSubtotales(){for(var subtotales=$(".subtotales span"),arraySumaSubtotales=[],i=0;i<subtotales.length;i++){var subtotalesArray=$(subtotales[i]).html();arraySumaSubtotales.push(Number(subtotalesArray))}function sumaArraySubtotales(total,numero){return total+numero}var sumaTotal=arraySumaSubtotales.reduce(sumaArraySubtotales,0);$(".sumaSubTotal").html("<strong>PEN S/.<span>"+sumaTotal.toFixed(2)+"</span></strong>"),$(".sumaCesta").html(sumaTotal.toFixed(2)),localStorage.setItem("sumaCesta",sumaTotal.toFixed(2))}function cestaCarrito(cantidadProductos){if(0!=cantidadProductos){for(var cantidadItem=$(".cuerpoCarrito .cantidadItem"),arraySumaCantidades=[],i=0;i<cantidadItem.length;i++){var cantidadItemArray=$(cantidadItem[i]).val();arraySumaCantidades.push(Number(cantidadItemArray))}function sumaArrayCantidades(total,numero){return total+numero}var sumaTotalCantidades=arraySumaCantidades.reduce(sumaArrayCantidades);$(".cantidadCesta").html(sumaTotalCantidades),localStorage.setItem("cantidadCesta",sumaTotalCantidades)}}function sumaTotalCompra(){var sumaTotalTasas=Number($(".valorSubtotal").html())+Number($(".valorTotalEnvio").html())+Number($(".valorTotalImpuesto").html());$(".valorTotalCompra").html(sumaTotalTasas.toFixed(2)),$(".valorTotalCompra").attr("valor",sumaTotalTasas.toFixed(2)),localStorage.setItem("total",hex_md5($(".valorTotalCompra").html()))}$(".agregarCarrito").click((function(){var idProducto=$(this).attr("idProducto"),imagen=$(this).attr("imagen"),titulo=$(this).attr("titulo"),precio=$(this).attr("precio"),tipo=$(this).attr("tipo"),peso=$(this).attr("peso"),stock=$(this).attr("stock"),agregarAlCarrito=!1;if("virtual"==tipo)agregarAlCarrito=!0;else for(var seleccionarDetalle=$(".seleccionarDetalle"),i=0;i<seleccionarDetalle.length;i++){if(""==$(seleccionarDetalle[i]).val())return void swal({title:"Debe seleccionar Talla y Color",text:"",type:"warning",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"¡Seleccionar!",closeOnConfirm:!1});titulo=titulo+"-"+$(seleccionarDetalle[i]).val(),agregarAlCarrito=!0}if(agregarAlCarrito){if(null==localStorage.getItem("listaProductos"))listaCarrito=[];else{for(var listaProductos=JSON.parse(localStorage.getItem("listaProductos")),i=0;i<listaProductos.length;i++)if(listaProductos[i].idProducto==idProducto&&"virtual"==listaProductos[i].tipo)return void swal({title:"El producto ya está agregado al carrito de compras",text:"",type:"warning",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"¡Volver!",closeOnConfirm:!1});listaCarrito.concat(localStorage.getItem("listaProductos"))}listaCarrito.push({idProducto:idProducto,imagen:imagen,titulo:titulo,precio:precio,tipo:tipo,peso:peso,stock:stock,cantidad:"1"}),localStorage.setItem("listaProductos",JSON.stringify(listaCarrito));var cantidadCesta=Number($(".cantidadCesta").html())+1,sumaCesta=Number($(".sumaCesta").html())+Number(precio);$(".cantidadCesta").html(cantidadCesta),$(".sumaCesta").html(sumaCesta),localStorage.setItem("cantidadCesta",cantidadCesta),localStorage.setItem("sumaCesta",sumaCesta),swal({title:"",text:"¡Se ha agregado un nuevo producto al carrito de compras!",type:"success",showCancelButton:!0,confirmButtonColor:"#DD6B55",cancelButtonText:"¡Continuar comprando!",confirmButtonText:"¡Ir a mi carrito de compras!",closeOnConfirm:!1},(function(isConfirm){isConfirm&&(window.location=rutaOculta+"carrito-de-compras")}))}})),$(document).on("click",".quitarItemCarrito",(function(){$(this).parent().parent().remove();var idProducto=$(".cuerpoCarrito button"),imagen=$(".cuerpoCarrito img"),titulo=$(".cuerpoCarrito .tituloCarritoCompra"),precio=$(".cuerpoCarrito .precioCarritoCompra span"),cantidad=$(".cuerpoCarrito .cantidadItem"),stock=$(".cuerpoCarrito .cantidadStock");if(listaCarrito=[],0!=idProducto.length){for(var i=0;i<idProducto.length;i++){var idProductoArray=$(idProducto[i]).attr("idProducto"),imagenArray=$(imagen[i]).attr("src"),tituloArray=$(titulo[i]).html(),precioArray=$(precio[i]).html(),pesoArray=$(idProducto[i]).attr("peso"),tipoArray=$(cantidad[i]).attr("tipo"),stockArray=$(stock[i]).html(),cantidadArray=$(cantidad[i]).val();listaCarrito.push({idProducto:idProductoArray,imagen:imagenArray,titulo:tituloArray,precio:precioArray,tipo:tipoArray,peso:pesoArray,stock:stockArray,cantidad:cantidadArray})}localStorage.setItem("listaProductos",JSON.stringify(listaCarrito)),sumaSubtotales(),cestaCarrito(listaCarrito.length)}else localStorage.removeItem("listaProductos"),localStorage.setItem("cantidadCesta","0"),localStorage.setItem("sumaCesta","0"),$(".cantidadCesta").html("0"),$(".sumaCesta").html("0"),$(".cuerpoCarrito").html('<div class="well"style="background-color: #0d1117;">Aún no hay productos en el carrito de compras.</div>'),$(".sumaCarrito").hide(),$(".cabeceraCheckout").hide()})),$(document).on("change",".cantidadItem",(function(){var cantidad=$(this).val(),precio=$(this).attr("precio"),idProducto=$(this).attr("idProducto"),stock=$(this).attr("stock");$(".subTotal"+idProducto).html("<strong>PEN S/.<span>"+cantidad*precio+"</span></strong>");var stockArray=$(stock).html(),idProducto=$(".cuerpoCarrito button"),imagen=$(".cuerpoCarrito img"),titulo=$(".cuerpoCarrito .tituloCarritoCompra"),precio=$(".cuerpoCarrito .precioCarritoCompra span"),cantidad=$(".cuerpoCarrito .cantidadItem"),stock=$(".cuerpoCarrito .cantidadStock");listaCarrito=[];for(var i=0;i<idProducto.length;i++){var idProductoArray=$(idProducto[i]).attr("idProducto"),imagenArray=$(imagen[i]).attr("src"),tituloArray=$(titulo[i]).html(),precioArray=$(precio[i]).html(),pesoArray=$(idProducto[i]).attr("peso"),tipoArray=$(cantidad[i]).attr("tipo"),stockArray=$(stock[i]).html(),cantidadArray=$(cantidad[i]).val();listaCarrito.push({idProducto:idProductoArray,imagen:imagenArray,titulo:tituloArray,precio:precioArray,tipo:tipoArray,peso:pesoArray,stock:stockArray,cantidad:cantidadArray})}for(var i=0;i<titulo.length;i++){var cantidadArray=$(cantidad[i]).val(),stockArray=$(stock[i]).html();localStorage.setItem("listaProductos",JSON.stringify(listaCarrito)),sumaSubtotales(),cestaCarrito(listaCarrito.length)}})),$("#btnCheckout").click((function(){$(".listaProductos table.tablaProductos tbody").html(""),$("#checkPayu").prop("checked",!1),$("#checkPaypal").prop("checked",!0);var idUsuario=$(this).attr("idUsuario"),peso=$(".cuerpoCarrito button, .comprarAhora button"),titulo=$(".cuerpoCarrito .tituloCarritoCompra, .comprarAhora .tituloCarritoCompra"),cantidad=$(".cuerpoCarrito .cantidadItem, .comprarAhora .cantidadItem"),subtotal=$(".cuerpoCarrito .subtotales span, .comprarAhora .subtotales span"),stock=$(".cuerpoCarrito .cantidadStock"),tipoArray=[],cantidadPeso=[],sumaSubTotal=$(".sumaSubTotal span");$(".valorSubtotal").html($(sumaSubTotal).html()),$(".valorSubtotal").attr("valor",$(sumaSubTotal).html());var impuestoTotal=$(".valorSubtotal").html()*$("#tasaImpuesto").val()/100;$(".valorTotalImpuesto").html(impuestoTotal.toFixed(2)),$(".valorTotalImpuesto").attr("valor",impuestoTotal.toFixed(2)),sumaTotalCompra();for(var i=0;i<titulo.length;i++){var pesoArray=$(peso[i]).attr("peso"),tituloArray=$(titulo[i]).html(),cantidadArray=$(cantidad[i]).val(),subtotalArray=$(subtotal[i]).html(),stockArray=$(stock[i]).html();function sumaArrayPeso(total,numero){return total+numero}cantidadPeso[i]=pesoArray*cantidadArray;var sumaTotalPeso=cantidadPeso.reduce(sumaArrayPeso);function checkTipo(tipo){return"fisico"==tipo}$(".listaProductos table.tablaProductos tbody").append('<tr style="color:black"><td style="color:black" class="valorTitulo">'+tituloArray+'</td><td style="color:black" class="valorCantidad">'+cantidadArray+'</td><td style="color:black"><span style="color:black" class="cambioDivisa">PEN</span> S/. <span style="color:black" class="valorItem" valor="'+subtotalArray+'"> '+subtotalArray+"</span></td></tr>"),tipoArray.push($(cantidad[i]).attr("tipo"))}"fisico"==tipoArray.find(checkTipo)?($(".seleccionePais").html('<select class="form-control" id="seleccionarPais" required><option value="JU" style="color:black">Seleccione la region</option></select>'),$(".formEnvio").show(),$(".btnPagar").attr("tipo","fisico"),$.ajax({url:rutaOculta+"vistas/js/plugins/departamentos.json",type:"GET",cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(respuesta){function seleccionarPais(item,index){var pais=item.name,codPais=item.code;$("#seleccionarPais").append('<option style="color:black" value="'+codPais+'">'+pais+"</option>")}respuesta.forEach(seleccionarPais)}}),$("#seleccionarPais").change((function(){var region,tasaRegion,resultadoPeso,resultadoPeso;($(".alert").remove(),$(this).val()==$("#tasaRegion").val())?(resultadoPeso=sumaTotalPeso*$("#envioLocal").val())<$("#tasaMinimaLocal").val()?($(".valorTotalEnvio").html($("#tasaMinimaLocal").val()),$(".valorTotalEnvio").attr("valor",$("#tasaMinimaLocal").val())):($(".valorTotalEnvio").html(resultadoPeso),$(".valorTotalEnvio").attr("valor",resultadoPeso)):(resultadoPeso=sumaTotalPeso*$("#envioNacional").val())<$("#tasaMinimaNacional").val()?($(".valorTotalEnvio").html($("#tasaMinimaNacional").val()),$(".valorTotalEnvio").attr("valor",$("#tasaMinimaNacional").val())):($(".valorTotalEnvio").html(resultadoPeso),$(".valorTotalEnvio").attr("valor",resultadoPeso));sumaTotalCompra(),pagarConPayu()}))):$(".btnPagar").attr("tipo","virtual")}));var metodoPago="paypal";function divisas(metodoPago){$("#cambiarDivisa").html(""),"paypal"==metodoPago?$("#cambiarDivisa").append('<option value="PEN" style="color:black" >PEN</option><option value="USD" style="color:black">USD</option>'):$("#cambiarDivisa").append('<option value="PEN" style="color:black">PEN</option><option value="USD" style="color:black">USD</option>')}divisas(metodoPago),$("input[name='pago']").change((function(){var metodoPago=$(this).val();divisas(metodoPago),"payu"==metodoPago?($(".btnPagar").hide(),$(".formPayu").show(),pagarConPayu()):($(".btnPagar").show(),$(".formPayu").hide())}));var divisaBase="PEN";function pagarConPayu(){if(""===$("#seleccionarPais").val())return $(".formPayu").after('<div class="alert alert-warning">No ha seleccionado el país de envío</div>'),void swal({title:"Debe seleccionar el pais de envio",text:"",type:"warning",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"¡Seleccionar!",closeOnConfirm:!1});for(var divisa=$("#cambiarDivisa").val(),total=$(".valorTotalCompra").html(),impuesto=$(".valorTotalImpuesto").html(),envio=$(".valorTotalEnvio").html(),subtotal=$(".valorSubtotal").html(),titulo=$(".valorTitulo"),cantidad=$(".valorCantidad"),valorItem=$(".valorItem"),idProducto=$(".cuerpoCarrito button, .comprarAhora button"),tituloArray=[],cantidadArray=[],idProductoArray=[],i=0;i<titulo.length;i++)tituloArray[i]=$(titulo[i]).html(),cantidadArray[i]=$(cantidad[i]).html(),idProductoArray[i]=$(idProducto[i]).attr("idProducto");var datos=new FormData;datos.append("metodoPago","payu"),hex_md5(total)==localStorage.getItem("total")&&$.ajax({url:rutaOculta+"ajax/carrito.ajax.php",method:"POST",data:datos,cache:!1,contentType:!1,processData:!1,success:function(respuesta){var merchantId=JSON.parse(respuesta).merchantIdPayu,accountId=JSON.parse(respuesta).accountIdPayu,apiKey=JSON.parse(respuesta).apiKeyPayu,modo=JSON.parse(respuesta).modoPayu,description=tituloArray.toString(),referenceCode=Number(Math.ceil(1e6*Math.random()))+Number(total).toFixed(),productosToString,productos=idProductoArray.toString().replace(/,/g,"-"),cantidadToString,cantidad=cantidadArray.toString().replace(/,/g,"-"),signature=hex_md5(apiKey+"~"+merchantId+"~"+referenceCode+"~"+total+"~"+divisa);if("COP"==divisa)var taxReturnBase=(total-impuesto).toFixed(2);else var taxReturnBase=0;if("sandbox"==modo)var url="https://sandbox.gateway.payulatam.com/ppp-web-gateway/",test=1;else var url="https://gateway.payulatam.com/ppp-web-gateway/",test=0;if(0!=envio)var tipoEnvio="YES";else var tipoEnvio="NO";$(".formPayu").attr("method","POST"),$(".formPayu").attr("action",url),$(".formPayu input[name='merchantId']").attr("value",merchantId),$(".formPayu input[name='accountId']").attr("value",accountId),$(".formPayu input[name='description']").attr("value",description),$(".formPayu input[name='referenceCode']").attr("value",referenceCode),$(".formPayu input[name='amount']").attr("value",total),$(".formPayu input[name='tax']").attr("value",impuesto),$(".formPayu input[name='taxReturnBase']").attr("value",taxReturnBase),$(".formPayu input[name='shipmentValue']").attr("value",envio),$(".formPayu input[name='currency']").attr("value",divisa),$(".formPayu input[name='responseUrl']").attr("value",rutaOculta+"index.php?ruta=finalizar-compra&payu=true&productos="+productos+"&cantidad="+cantidad),$(".formPayu input[name='declinedResponseUrl']").attr("value",rutaOculta+"carrito-de-compras"),$(".formPayu input[name='displayShippingInformation']").attr("value",tipoEnvio),$(".formPayu input[name='test']").attr("value",test),$(".formPayu input[name='signature']").attr("value",signature)}})}$("#cambiarDivisa").change((function(){if($(".alert").remove(),""!=$("#seleccionarPais").val()){var divisa=$(this).val();$.ajax({url:"https://free.currconv.com/api/v7/convert?q="+divisaBase+"_"+divisa+"&compact=ultra&apiKey=adb79720d66aeb836f75",type:"GET",cache:!1,contentType:!1,processData:!1,dataType:"jsonp",success:function(respuesta){var conversion=respuesta["PEN_"+divisa].toFixed(2);if($(".cambioDivisa").html(divisa),"PEN"==divisa){$(".valorSubtotal").html($(".valorSubtotal").attr("valor")),$(".valorTotalEnvio").html($(".valorTotalEnvio").attr("valor")),$(".valorTotalImpuesto").html($(".valorTotalImpuesto").attr("valor")),$(".valorTotalCompra").html($(".valorTotalCompra").attr("valor"));var valorItem=$(".valorItem");localStorage.setItem("total",hex_md5($(".valorTotalCompra").html()));for(var i=0;i<valorItem.length;i++)$(valorItem[i]).html($(valorItem[i]).attr("valor"))}else{$(".valorSubtotal").html(Math.ceil(Number(conversion)*Number($(".valorSubtotal").attr("valor"))*100)/100),$(".valorTotalEnvio").html((Number(conversion)*Number($(".valorTotalEnvio").attr("valor"))).toFixed(2)),$(".valorTotalImpuesto").html((Number(conversion)*Number($(".valorTotalImpuesto").attr("valor"))).toFixed(2)),$(".valorTotalCompra").html((Number(conversion)*Number($(".valorTotalCompra").attr("valor"))).toFixed(2));var valorItem=$(".valorItem");localStorage.setItem("total",hex_md5($(".valorTotalCompra").html()));for(var i=0;i<valorItem.length;i++)$(valorItem[i]).html((Number(conversion)*Number($(valorItem[i]).attr("valor"))).toFixed(2)),pagarConPayu()}}})}else $("#cambiarDivisa").after('<div class="alert alert-warning">No ha seleccionado la region de envío</div>')})),$(".btnPagar").click((function(){var tipo;if("fisico"!=$(this).attr("tipo")||""!=$("#seleccionarPais").val()){for(var divisa=$("#cambiarDivisa").val(),total=$(".valorTotalCompra").html(),totalEncriptado=localStorage.getItem("total"),impuesto=$(".valorTotalImpuesto").html(),envio=$(".valorTotalEnvio").html(),subtotal=$(".valorSubtotal").html(),titulo=$(".valorTitulo"),cantidad=$(".valorCantidad"),valorItem=$(".valorItem"),idProducto=$(".cuerpoCarrito button, .comprarAhora button"),tituloArray=[],cantidadArray=[],valorItemArray=[],idProductoArray=[],i=0;i<titulo.length;i++)tituloArray[i]=$(titulo[i]).html(),cantidadArray[i]=$(cantidad[i]).html(),valorItemArray[i]=$(valorItem[i]).html(),idProductoArray[i]=$(idProducto[i]).attr("idProducto");var datos=new FormData;datos.append("divisa",divisa),datos.append("total",total),datos.append("totalEncriptado",totalEncriptado),datos.append("impuesto",impuesto),datos.append("envio",envio),datos.append("subtotal",subtotal),datos.append("tituloArray",tituloArray),datos.append("cantidadArray",cantidadArray),datos.append("valorItemArray",valorItemArray),datos.append("idProductoArray",idProductoArray),$.ajax({url:rutaOculta+"ajax/carrito.ajax.php",method:"POST",data:datos,cache:!1,contentType:!1,processData:!1,success:function(respuesta){location=respuesta}})}else $(".btnPagar").after('<br><div class="alert alert-warning">No ha seleccionado la region de envío</div>')}));